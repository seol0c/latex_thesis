<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chapters Viewer + PDF</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github.min.css">
<style>
  :root { --bg:#0b0c0f; --pane:#111318; --muted:#a7b0c0; --text:#e9edf5; --accent:#3ea6ff; --border:#262a33; }

  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font:14px/1.45 ui-sans-serif,'Noto Sans KR'; }

  /* ✅ 트리 패널 폭 200px */
  main {
    display:grid;
    grid-template-columns:200px 1fr minmax(360px,42vw);
    height:100vh;
  }

  aside, section, article { border-right:1px solid var(--border); }
  aside  { overflow:auto; background:#0d1015; }
  section{ overflow:auto; background:#0b0d12; }
  article{ overflow:auto; background:#0b0d12; }

  /* ✅ 트리 스타일 VSCode 스타일 */
  .tree { list-style:none; margin:0; padding:6px; }
  .tree li { margin:0; padding:0; }

  .node {
    display:flex; align-items:center;
    gap:4px;
    padding:3px 4px;
    border-radius:4px;
    cursor:pointer;
    font-size:13px;
  }
  .node:hover { background:#101520; }

  .dir .name { color:#9ad1ff; }
  .file .name { color:#e8ecf6; }

  /* ✅ 들여쓰기 최소화 */
  .indent { margin-left:14px; padding-left:4px; border-left:none; }

  /* ✅ caret 정렬 */
  .caret { width:12px; display:inline-block; text-align:center; }

  .toolbar {
    padding:4px 8px;
    border-bottom:1px solid var(--border);
    background:#0e1116;
    font-family:ui-monospace,Consolas,monospace;
    color:#b7c2d8;
    font-size:13px;
  }

  pre { margin:0; padding:10px 12px; overflow:auto; }
  code { font:12px/1.5 'SFMono-Regular',Consolas,monospace; }

  iframe { width:100%; height:100%; border:0; }
</style>
</head>
<body>

<main>
  <aside><ul id="tree" class="tree"></ul></aside>

  <section>
    <div class="toolbar" id="codePath">코드 파일 선택</div>
    <pre><code id="codeblock" class="hljs">좌측에서 파일을 선택하세요.</code></pre>
  </section>

  <article>
    <iframe id="pdfFrame"></iframe>
  </article>
</main>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/latex.min.js"></script>

<script>
const owner  = "seol0c";
const repo   = "latex_thesis";
const branch = "main";
const pdfPath = "main/main.pdf";

const treeEl = document.querySelector("#tree");
const codeBlock = document.querySelector("#codeblock");
const codePath  = document.querySelector("#codePath");
const pdfFrame  = document.querySelector("#pdfFrame");

const extsMap = {
  'tex':'latex','sty':'latex','cls':'latex','bib':'latex',
  'md':'markdown','json':'json','yml':'yaml','yaml':'yaml',
  'js':'javascript','ts':'typescript','py':'python','html':'xml',
  'xml':'xml','css':'css','txt':'plaintext'
};
function langFromExt(p){
  const m = p.toLowerCase().match(/\.([a-z0-9]+)$/);
  return m ? (extsMap[m[1]] || 'plaintext') : 'plaintext';
}

/* ✅ GitHub API rate-limit을 피하기 위해 contents API로 바꿈 */
async function getDir(path="chapters") {
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error("API 오류");
  return await r.json();
}

/* ✅ 폴더 구조 재귀적으로 읽기 */
async function readFolder(base="chapters", prefix="") {
  const list = await getDir(base);
  const tree = {};

  for (const item of list) {
    if (item.type === "dir") {
      tree[item.name] = {
        _type: "tree",
        _children: await readFolder(base + "/" + item.name, prefix + item.name + "/")
      };
    } else {
      tree[item.name] = { _type: "blob" };
    }
  }
  return tree;
}

/* ✅ 트리 렌더링 */
function renderTree(node, path="") {
  const ul = document.createElement("ul");
  ul.className = path ? "indent" : "";

  const names = Object.keys(node).sort((a,b)=>{
    const ad = node[a]._type==="tree" ? 0 : 1;
    const bd = node[b]._type==="tree" ? 0 : 1;
    return ad - bd || a.localeCompare(b);
  });

  for (const name of names) {
    const info = node[name];
    const li = document.createElement("li");
    const row = document.createElement("div");

    row.className = "node " + (info._type==="tree" ? "dir" : "file");
    const caret = document.createElement("span");
    caret.className = "caret";
    caret.textContent = info._type==="tree" ? "▸" : "";

    const label = document.createElement("span");
    label.className = "name";
    label.textContent = name;

    row.appendChild(caret);
    row.appendChild(label);
    li.appendChild(row);

    if (info._type === "tree") {
      const sub = renderTree(info._children, path + name + "/");
      sub.style.display = "none";

      row.addEventListener("click", () => {
        const show = sub.style.display==="none";
        sub.style.display = show ? "block" : "none";
        caret.textContent = show ? "▾" : "▸";
      });

      li.appendChild(sub);
    } else {
      row.addEventListener("click", () => openCode(path + name));
    }

    ul.appendChild(li);
  }

  return ul;
}

/* ✅ Code 오픈 */
async function openCode(path){
  codePath.textContent = path;
  try {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/chapters/${path}?ref=${branch}`;
    const r = await fetch(url);
    const j = await r.json();
    const text = atob(j.content.replace(/\n/g,""));
    const decoded = new TextDecoder("utf-8").decode(
      new Uint8Array([...text].map(c=>c.charCodeAt(0)))
    );

    const lang = langFromExt(path);
    codeBlock.className = "hljs " + lang;
    codeBlock.textContent = decoded;
    hljs.highlightElement(codeBlock);
  } catch(e) {
    codeBlock.textContent = "불러오기 실패";
  }
}

/* ✅ Boot */
async function bootstrap(){
  treeEl.innerHTML = "<li style='padding:6px;color:#999'>불러오는 중…</li>";

  const root = await readFolder("chapters");
  treeEl.innerHTML = "";
  treeEl.appendChild(renderTree(root, ""));
}
bootstrap();

/* ✅ PDF */
pdfFrame.src = `/${repo}/pdfjs/web/viewer.html?file=/${repo}/${pdfPath}`;
</script>

</body>
</html>
