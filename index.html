<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repo Viewer + PDF</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github.min.css">

<style>
  :root { --bg:#0b0c0f; --pane:#111318; --muted:#a7b0c0; --text:#e9edf5; --accent:#3ea6ff; --border:#262a33; }
  *{box-sizing:border-box} 
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,'Segoe UI','Noto Sans KR';}

  /* ✅ 트리 폭 260px → 200px로 축소 */
  main{display:grid;grid-template-columns:200px 1fr minmax(360px,42vw);height:100vh}

  aside,section,article{border-right:1px solid var(--border)}
  aside{overflow:auto;background:#0d1015}
  section{overflow:auto;background:#0b0d12}
  article{overflow:auto;background:#0b0d12;border-right:none}

  /* ✅ 들여쓰기 최소화 */
  .tree{list-style:none;margin:0;padding:4px}
  .tree li{margin:1px 0;padding:1px 0}
  .node{display:flex;align-items:center;gap:6px;padding:3px 4px;border-radius:4px;cursor:pointer;color:#d7deea}
  .node:hover{background:#101520}
  .dir>.name{color:#9ad1ff}
  .file>.name{color:#e8ecf6}

  /* ✅ 들여쓰기 거의 제거 */
  .indent{margin-left:6px;border-left:none;padding-left:4px}

  .toolbar{padding:6px 10px;border-bottom:1px solid var(--border);background:#0e1116;font-family:ui-monospace;color:#b7c2d8}
  pre{margin:0;padding:14px 16px;overflow:auto}
  code{font:12px/1.5 'SFMono-Regular',Consolas,monospace}

  iframe{width:100%;height:100%;border:0}
</style>
</head>
<body>

<main>
  <aside><ul id="tree" class="tree"></ul></aside>

  <section>
    <div class="toolbar" id="codePath">코드 파일 선택</div>
    <pre><code id="codeblock" class="hljs">좌측 트리에서 파일을 선택하십시오.</code></pre>
  </section>

  <article>
    <iframe id="pdfFrame"></iframe>
  </article>
</main>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/latex.min.js"></script>

<script>
  const repo = "latex_thesis";
  const owner = "seol0c";
  const branch = "main";
  const mainPdf = "main/main.pdf";

  const el = (s)=>document.querySelector(s);
  const treeEl = el('#tree');
  const codeBlock = el('#codeblock');
  const codePath = el('#codePath');
  const pdfFrame = el('#pdfFrame');

  const extsMap = {
    'tex':'latex','sty':'latex','cls':'latex','bib':'latex',
    'md':'markdown','json':'json','yml':'yaml','yaml':'yaml',
    'js':'javascript','ts':'typescript','py':'python','html':'xml','xml':'xml','css':'css','txt':'plaintext'
  };

  const langFromExt = (p)=>{
    const m = p.toLowerCase().match(/\.([a-z0-9]+)$/);
    return m ? (extsMap[m[1]]||'plaintext') : 'plaintext';
  };

  const fetchTree = async()=>{
    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`);
    return (await r.json()).tree;
  };

  const fetchFile = async(path)=>{
    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`);
    const j = await r.json();
    if(j.encoding==="base64"){
      const bin = atob(j.content.replace(/\n/g,''));
      const buf = new Uint8Array([...bin].map(c=>c.charCodeAt(0)));
      return new TextDecoder("utf-8").decode(buf);
    }
    return j.content;
  };

  async function openCode(path){
    codePath.textContent = path;
    try{
      const txt = await fetchFile(path);
      const lang = langFromExt(path);
      codeBlock.className = 'hljs '+lang;
      codeBlock.textContent = txt;
      hljs.highlightElement(codeBlock);
    }catch{
      codeBlock.textContent = '불러오기 실패';
    }

    if(path.toLowerCase().endsWith('.pdf')){
      pdfFrame.src = `/${repo}/pdfjs/web/viewer.html?file=/${repo}/${path}`;
    }
  }

  /* ✅ 트리 구조 만들기 */
  const buildTreeStruct = (items)=>{
    const root = {};
    for(const it of items){
      const segs = it.path.split('/');
      let cur = root;
      for(let i=0;i<segs.length;i++){
        const s = segs[i];
        cur[s] = cur[s] || {};
        if(i===segs.length-1) cur[s]._type = it.type;
        cur = cur[s];
      }
    }
    return root;
  };

  /* ✅ 트리 렌더링 (들여쓰기 최소화) */
  const renderTree = (node, base='')=>{
    const ul = document.createElement('ul');
    ul.className = base? 'indent':'';
    const names = Object.keys(node).filter(k=>!k.startsWith('_'))
      .sort((a,b)=>{
        const ad=(node[a]._type==='tree'?0:1);
        const bd=(node[b]._type==='tree'?0:1);
        return ad-bd||a.localeCompare(b);
      });
    for(const name of names){
      const child=node[name];
      const li=document.createElement('li');
      const row=document.createElement('div');
      const isDir=(child._type==='tree');
      row.className='node '+(isDir?'dir':'file');

      const caret=document.createElement('span');
      caret.textContent=isDir?'▸':'•';
      caret.style.minWidth='12px';

      const label=document.createElement('span');
      label.className='name';
      label.textContent=name;

      row.appendChild(caret);
      row.appendChild(label);
      li.appendChild(row);

      if(isDir){
        const sub=renderTree(child, base+name+'/');
        sub.style.display='none';
        row.addEventListener('click',()=>{
          sub.style.display=sub.style.display==='none'?'block':'none';
          caret.textContent=sub.style.display==='none'?'▸':'▾';
        });
        li.appendChild(sub);
      }else{
        row.addEventListener('click',()=>openCode(base+name));
      }
      ul.appendChild(li);
    }
    return ul;
  };

  /* ✅ 핵심: chapters 아래만 root로 승격 */
async function bootstrap(){
  treeEl.innerHTML = '<li class="muted" style="padding:8px">불러오는 중…</li>';

  const all = await fetchTree();

  // ✅ 1) chapters/ 아래만 남기기
  const raw = all.filter(x => x.path.startsWith("chapters/"));

  // ✅ 2) type(tree/blob) 유지한 채 path만 변환
  const stripped = raw.map(x => ({
    path: x.path.replace(/^chapters\//, ""),
    type: x.type   // ← 절대 변형하면 안 됨
  }));

  // ✅ 3) 트리 구조 생성
  const root = buildTreeStruct(stripped);

  treeEl.innerHTML='';
  treeEl.appendChild(renderTree(root,''));
}

  bootstrap();

  setTimeout(()=> pdfFrame.src=`/${repo}/pdfjs/web/viewer.html?file=/${repo}/${mainPdf}`, 400);
</script>
</body>
</html>
