<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repo Viewer + PDF</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github.min.css">
<style>
  :root { --bg:#0b0c0f; --pane:#111318; --muted:#a7b0c0; --text:#e9edf5; --accent:#3ea6ff; --border:#262a33; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,'Segoe UI',Roboto,'Apple SD Gothic Neo','Noto Sans KR',Helvetica,Arial;}
  header{padding:10px 14px;border-bottom:1px solid var(--border);background:var(--pane);display:flex;gap:10px;align-items:center}
  header h1{margin:0;font-size:14px;font-weight:600;color:var(--muted)}
  header .cfg{display:flex;gap:8px;align-items:center;color:var(--muted)}
  header input{background:#0e1116;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px;min-width:140px}
  header button{background:#1a2332;border:1px solid var(--border);color:#cfe6ff;padding:6px 10px;border-radius:8px;cursor:pointer}
  main{display:grid;grid-template-columns:280px 1fr minmax(360px,42vw);height:calc(100vh - 50px)}
  aside,section,article{border-right:1px solid var(--border)}
  aside{overflow:auto;background:#0d1015}
  section{overflow:auto;background:#0b0d12}
  article{overflow:auto;background:#0b0d12;border-right:none}
  .tree{list-style:none;margin:0;padding:8px}
  .tree li{margin:1px 0;padding:2px 0}
  .node{display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:6px;cursor:pointer;color:#d7deea}
  .node:hover{background:#101520}
  .dir>.name{color:#9ad1ff}
  .file>.name{color:#e8ecf6}
  .muted{color:var(--muted)}
  .indent{margin-left:16px;border-left:1px dashed #263040;padding-left:10px}
  pre{margin:0;padding:14px 16px;white-space:pre;overflow:auto}
  code{font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .toolbar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border);background:#0e1116}
  .toolbar .path{color:#b7c2d8;font-family:ui-monospace,Consolas,monospace}
  .toolbar .actions{display:flex;gap:8px}
  .toolbar a, .toolbar button{background:#152033;border:1px solid var(--border);color:#cfe6ff;padding:6px 10px;border-radius:8px;text-decoration:none}
  iframe{width:100%;height:calc(100% - 40px);border:0}
  .pdfbar{padding:8px 10px;border-bottom:1px solid var(--border);background:#0e1116;display:flex;justify-content:space-between;align-items:center}
  .pdfbar input{flex:1;margin-left:10px}
  .hint{padding:10px 12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Repo Viewer + PDF</h1>
  <div class="cfg">
    <span>owner</span><input id="owner" value="seol0c">
    <span>repo</span><input id="repo" value="latex_thesis">
    <span>branch</span><input id="branch" value="main">
    <button id="loadBtn">불러오기</button>
  </div>
</header>

<main>
  <aside>
    <ul id="tree" class="tree"></ul>
  </aside>

  <section>
    <div class="toolbar">
      <div class="path" id="codePath">코드 파일 선택</div>
      <div class="actions">
        <a id="rawLink" href="#" target="_blank" rel="noopener">RAW 열기</a>
      </div>
    </div>
    <pre><code id="codeblock" class="hljs">좌측 트리에서 파일을 선택하십시오.</code></pre>
  </section>

  <article>
    <div class="pdfbar">
      <div>PDF 보기</div>
      <div style="display:flex;gap:8px;align-items:center;width:70%;">
        <span class="muted">경로:</span>
        <input id="pdfInput" value="main/main.pdf" />
        <button id="openPdf">열기</button>
      </div>
    </div>
    <iframe id="pdfFrame" title="PDF"></iframe>
    <div class="hint">※ PDF 경로는 레포 기준 상대경로입니다. 예: <code>thesis.pdf</code>, <code>main/main.pdf</code></div>
  </article>
</main>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/languages/latex.min.js"></script>
<script>
  const el = (sel) => document.querySelector(sel);
  const treeEl = el('#tree');
  const codeBlock = el('#codeblock');
  const codePath = el('#codePath');
  const rawLink = el('#rawLink');
  const pdfFrame = el('#pdfFrame');
  const pdfInput = el('#pdfInput');

  const extsMap = {
    'tex':'latex','sty':'latex','cls':'latex','bib':'latex',
    'md':'markdown','json':'json','yml':'yaml','yaml':'yaml',
    'js':'javascript','ts':'typescript','py':'python','html':'xml','xml':'xml','css':'css','txt':'plaintext'
  };

  function langFromExt(path){
    const m = path.toLowerCase().match(/\.([a-z0-9]+)$/);
    if(!m) return 'plaintext';
    return extsMap[m[1]] || 'plaintext';
  }

  function buildTree(paths){
    // paths: array of {path, type:file|tree}
    const root = {};
    for(const item of paths){
      const segs = item.path.split('/');
      let cur = root;
      for(let i=0;i<segs.length;i++){
        const s = segs[i];
        if(i === segs.length-1){
          cur[s] = cur[s] || {};
          cur[s]._type = item.type; // "blob" -> file, "tree" -> dir (normalized later)
        }else{
          cur[s] = cur[s] || {};
        }
        cur = cur[s];
      }
    }
    return root;
  }

  function renderTree(node, base = ''){
    const ul = document.createElement('ul');
    ul.className = base ? 'indent' : '';
    const names = Object.keys(node).filter(k=>!k.startsWith('_')).sort((a,b)=>{
      const ad = (node[a]._type||'tree')==='tree'?0:1;
      const bd = (node[b]._type||'tree')==='tree'?0:1;
      return ad-bd || a.localeCompare(b);
    });
    for(const name of names){
      const child = node[name];
      const li = document.createElement('li');
      const isDir = (child._type||'tree')==='tree';
      const row = document.createElement('div');
      row.className = 'node ' + (isDir?'dir':'file');
      const caret = document.createElement('span');
      caret.textContent = isDir ? '▸' : '•';
      caret.style.minWidth = '14px';
      const label = document.createElement('span');
      label.className = 'name';
      label.textContent = name;
      row.appendChild(caret);
      row.appendChild(label);

      li.appendChild(row);
      if(isDir){
        const sub = renderTree(child, base + name + '/');
        sub.style.display = 'none';
        row.addEventListener('click', ()=>{
          sub.style.display = (sub.style.display==='none')?'block':'none';
          caret.textContent = sub.style.display==='none' ? '▸' : '▾';
        });
        li.appendChild(sub);
      }else{
        row.addEventListener('click', ()=> openCode(base + name));
      }
      ul.appendChild(li);
    }
    return ul;
  }

  async function fetchTree(owner, repo, branch){
    const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('트리 조회 실패: ' + res.status);
    const data = await res.json();
    // normalize to {path, type: 'tree'|'blob'}
    return data.tree.map(x=>({path:x.path, type:x.type}));
  }

  async function fetchFile(owner, repo, branch, path){
    // GitHub contents API (base64)
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('파일 조회 실패: ' + res.status);
    const data = await res.json();
    if(data.type !== 'file') throw new Error('파일이 아님');
    if(data.encoding === 'base64'){
      const b64 = data.content.replace(/\n/g,'');
      const decoded = decodeURIComponent(escape(atob(b64)));
      return decoded;
    }
    return data.content || '';
  }

  function rawUrl(owner, repo, branch, path){
    return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
  }

  async function openCode(path){
    const owner = el('#owner').value.trim();
    const repo  = el('#repo').value.trim();
    const branch= el('#branch').value.trim();

    codePath.textContent = path;
    rawLink.href = rawUrl(owner, repo, branch, path);

    try{
      const content = await fetchFile(owner, repo, branch, path);
      const lang = langFromExt(path);
      codeBlock.className = 'hljs ' + (lang==='plaintext'?'':lang);
      codeBlock.textContent = content;
      hljs.highlightElement(codeBlock);
    }catch(e){
      codeBlock.className = 'hljs';
      codeBlock.textContent = `불러오기 실패: ${e.message}`;
    }

    // PDF 파일이면 우측에도 바로 띄움
    if(path.toLowerCase().endsWith('.pdf')){
      pdfInput.value = path;
      openPdf();
    }
  }

  function openPdf(){
    const owner = el('#owner').value.trim();
    const repo  = el('#repo').value.trim();
    const branch= el('#branch').value.trim();
    const rel   = pdfInput.value.trim().replace(/^\/+/,'');
    // Pages에서 같은 레포를 호스팅 중이면 아래처럼 접근 (프로젝트 Pages 기준)
    const href = `/${repo}/${rel}`;
    // 상대경로: 현재 도메인(seol0c.github.io) 기준으로 로드
    pdfFrame.src = href;
  }

  async function bootstrap(){
    const owner = el('#owner').value.trim();
    const repo  = el('#repo').value.trim();
    const branch= el('#branch').value.trim();

    treeEl.innerHTML = '<li class="muted" style="padding:8px">트리 불러오는 중…</li>';
    try{
      const items = await fetchTree(owner, repo, branch);
      // GitHub API: type 'tree'는 디렉터리, 'blob'은 파일
      const normalized = items.map(x=>({path:x.path, type: x.type==='tree'?'tree':'treeOrFile'}));
      // 실제 타입 유지
      const root = {};
      for(const it of items){
        const segs = it.path.split('/');
        let cur = root;
        for(let i=0;i<segs.length;i++){
          const s = segs[i];
          if(!cur[s]) cur[s] = {};
          if(i===segs.length-1){
            cur[s]._type = (it.type==='tree')?'tree':'blob';
          }
          cur = cur[s];
        }
      }
      treeEl.innerHTML = '';
      treeEl.appendChild(renderTree(root, ''));
    }catch(e){
      treeEl.innerHTML = `<li class="muted" style="padding:8px">트리 로드 실패: ${e.message}</li>`;
    }
  }

  el('#loadBtn').addEventListener('click', bootstrap);
  el('#openPdf').addEventListener('click', openPdf);

  // 초기 로드
  bootstrap();
  // 초기 PDF 프리뷰
  setTimeout(openPdf, 400);
</script>
</body>
</html>
